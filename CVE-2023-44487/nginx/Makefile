SHELL = /usr/bin/env bash -o pipefail
.SHELLFLAGS = -ec
.DEFAULT_GOAL := gateway
MKFILE_PATH := $(abspath $(lastword $(MAKEFILE_LIST)))
WORKDIR := $(patsubst %/,%,$(dir $(MKFILE_PATH)))
DOCKER ?= $(shell which docker 2> /dev/null || echo "docker")

nginx: 
	$(DOCKER) run --name nginx --rm -p 443:443 \
   -v $(WORKDIR)/nginx.conf:/etc/nginx/nginx.conf \
   -v $(WORKDIR)/certs:/certs \
	 nginx:1.19.3

.PHONY: certs
certs:
	$(MAKE) clean -C $(WORKDIR)/certs -f $(WORKDIR)/certs/Makefile
	$(MAKE) ca -C $(WORKDIR)/certs -f $(WORKDIR)/certs/Makefile
	$(MAKE) clientcerts -C $(WORKDIR)/certs -f $(WORKDIR)/certs/Makefile DOMAIN=example.com
