SHELL = /usr/bin/env bash -o pipefail
.SHELLFLAGS = -ec
.DEFAULT_GOAL := gateway
MKFILE_PATH := $(abspath $(lastword $(MAKEFILE_LIST)))
WORKDIR := $(patsubst %/,%,$(dir $(MKFILE_PATH)))
DOCKER ?= $(shell which docker 2> /dev/null || echo "docker")

openresty:
	$(DOCKER) run --name openresty --rm -p 443:443 \
   -v $(WORKDIR)/conf.d:/etc/nginx/conf.d \
   -v $(WORKDIR)/certs:/certs \
	 openresty/openresty:1.19.3.1-alpine

.PHONY: certs
certs:
	$(MAKE) clean -C $(WORKDIR)/certs -f $(WORKDIR)/certs/Makefile
	$(MAKE) ca -C $(WORKDIR)/certs -f $(WORKDIR)/certs/Makefile
	$(MAKE) clientcerts -C $(WORKDIR)/certs -f $(WORKDIR)/certs/Makefile DOMAIN=example.com
